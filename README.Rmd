---
title: netvis
output:
  github_document:
    number_sections: yes
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  warning = FALSE,
  message = FALSE
)
library(tidyverse)
library(tmap)
tmap_mode("view")
```

<!-- badges: start -->
<!-- badges: end -->

The goal of this repo is to demonstrate different visualisation techniques for communicating information about transport networks.

```{r, eval = FALSE, echo=FALSE}
# install.packages("devtools")
devtools::install_github("ITSLeeds/netvis")
```

# Example data

We'll use a route network dataset from the Propensity to Cycle Tool (PCT) to demonstrate the package. The PCT is a web application that allows users to explore cycling potential across England and Wales. The PCT is available at [www.pct.bike](https://www.pct.bike/).

# Static data visualisation

A simple visualisation of the data in a multi-panel static map is shown below.

```{r, echo=FALSE}
rnet_leeds = pct::get_pct_rnet("west-yorkshire")
rnet_leeds = rnet_leeds |>
  select(-1)
zones_leeds = zonebuilder::zb_zone("Leeds")
central_leeds = zones_leeds |>
  dplyr::filter(circle_id == 1) |>
  sf::st_union()
rnet_central = sf::st_intersection(rnet_leeds, central_leeds)
plot(rnet_central)
# sf::st_write(rnet_central, "test-data/rnet_central.geojson", delete_dsn = TRUE)
```

# Interactive data visualisation with line widths

The `tmap` package provides a simple way to create interactive maps. The code below shows how to create an interactive map of the route network data.

```{r, echo=FALSE}
m1 =
  tm_shape(rnet_central) +
  tm_lines(
    lwd = "bicycle",
    scale = 9
  )
tmap_save(m1, "maps/m1.html")
# browseURL("maps/m1.html")
webshot2::webshot("maps/m1.html")
width_multiplier = round(max(rnet_central$dutch_slc) / max(rnet_central$bicycle))
```

The maximum level of flow in the Go Dutch scenario is `r round(width_multiplier)` times the maximum level of flow in the baseline scenario. We can use this to scale the line widths as illustrated below.

```{r, echo=FALSE, out.width="50%", fig.show="hold"}
m2 = tm_shape(rnet_central) +
  tm_lines(
    lwd = "dutch_slc",
    scale = 9 * width_multiplier
  )
tmap_save(m2, "maps/m2.html")
# browseURL("maps/m2.html")
webshot2::webshot("maps/m1.html")
webshot2::webshot("maps/m2.html")
```

There are two problems with line widths in the maps shown above:

- The thinnes lines are too thin
- The thickest lines are too thick

Given that the maximum width is determined by the `scale` argument, we can solve the first problem by increasing the value of `scale`.
The second problem can be solved with a multiplier that prevents lines being x times thicker than the thinnest line.

```{r, echo=FALSE}
maximum_width = 15
minimum_width_multiplier = 5
# get 95th percentile of line widths
combined_values = rnet_central |>
  sf::st_drop_geometry() |>
  sapply(function(x) {
    quantile(x, 0.95)
  }
  )
minimum_value_allowed = max(combined_values) / minimum_width_multiplier
```

```{r, echo=FALSE, out.width="50%", fig.show="hold"}
scale_bicycle = maximum_width / (quantile(rnet_central$dutch_slc, 0.95) / quantile(rnet_central$bicycle, 0.95))
# summary(rnet_central$bicycle)
rnet_bicycle =   rnet_central |>
    mutate(lwd = case_when(
      bicycle < minimum_value_allowed ~ minimum_value_allowed,
      TRUE ~ bicycle
    ))
# summary(rnet_bicycle$lwd)
m3 = tm_shape(
  rnet_bicycle
 ) +
  tm_lines(
    lwd = "lwd",
    scale = scale_bicycle
  )
tmap_save(m3, "maps/m3.html")
# browseURL("maps/m3.html")
webshot2::webshot("maps/m3.html")

# For the Go Dutch scenario
scale_dutch = maximum_width
m4 = tm_shape(
  rnet_central |>
    mutate(lwd = case_when(
      dutch_slc < minimum_value_allowed ~ minimum_value_allowed,
      TRUE ~ dutch_slc
    ))
 ) +
  tm_lines(
    lwd = "lwd",
    scale = scale_dutch
  )
tmap_save(m4, "maps/m4.html")
# browseURL("maps/m4.html")
webshot2::webshot("maps/m4.html")
```